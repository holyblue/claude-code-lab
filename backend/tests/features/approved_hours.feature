Feature: 專案核定工時追蹤與扣抵
  作為專案管理者
  我想要追蹤專案的核定工時使用情況
  以便控制專案成本並預警超支

  Background:
    Given 存在以下專案
      | 專案代碼    | 專案名稱 | 核定工時(人天) | 核定工時(小時) |
      | 需2025單001 | AI系統   | 20             | 150.0          |
    And 存在以下工作類別
      | 代碼 | 名稱 | 是否扣抵核定工時 |
      | A07  | 其它 | 是               |
      | A08  | 商模 | 否               |
      | B04  | 其它 | 是               |
      | I07  | 休假 | 否               |

  # Scenario 1: 一般工作類別扣抵核定工時
  Scenario: 填寫 A07 其它工作，應扣抵核定工時
    Given 專案 "需2025單001" 的核定工時為 150.0 小時
    And 已使用工時為 0 小時
    When 我記錄以下工時
      | 專案代碼    | 工作類別 | 工時 |
      | 需2025單001 | A07 其它 | 8.0  |
    Then 專案 "需2025單001" 的已使用工時應為 8.0 小時
    And 剩餘工時應為 142.0 小時
    And 使用率應為 5.3%

  # Scenario 2: A08 商模不扣抵核定工時
  Scenario: 填寫 A08 商模工作，不扣抵核定工時
    Given 專案 "需2025單001" 的核定工時為 150.0 小時
    And 已使用工時為 50.0 小時
    When 我記錄以下工時
      | 專案代碼    | 工作類別 | 工時 |
      | 需2025單001 | A08 商模 | 12.0 |
    Then 專案 "需2025單001" 的已使用工時應仍為 50.0 小時
    And 不扣抵工時應為 12.0 小時
    And 剩餘工時應為 100.0 小時
    And 使用率應為 33.3%

  # Scenario 3: 混合工作類別的工時計算
  Scenario: 同時填寫扣抵與不扣抵類別
    Given 專案 "需2025單001" 的核定工時為 150.0 小時
    And 已使用工時為 0 小時
    When 我記錄以下工時
      | 專案代碼    | 工作類別 | 工時 |
      | 需2025單001 | A07 其它 | 4.0  |
      | 需2025單001 | A08 商模 | 2.0  |
      | 需2025單001 | B04 其它 | 3.0  |
    Then 專案 "需2025單001" 的已使用工時應為 7.0 小時
    And 不扣抵工時應為 2.0 小時
    And 專案總工時應為 9.0 小時
    And 剩餘工時應為 143.0 小時
    And 使用率應為 4.7%

  # Scenario 4: 核定工時超過 80% 預警
  Scenario: 專案工時使用率超過 80% 應顯示警告
    Given 專案 "需2025單001" 的核定工時為 150.0 小時
    And 已使用工時為 120.0 小時
    When 我查看專案統計
    Then 使用率應為 80.0%
    And 應該顯示橘色預警
    And 警告訊息應為 "專案工時使用率已達 80.0%，請注意控制"

  # Scenario 5: 核定工時用完
  Scenario: 專案工時使用率達到或超過 100%
    Given 專案 "需2025單001" 的核定工時為 150.0 小時
    And 已使用工時為 150.0 小時
    When 我嘗試記錄以下工時
      | 專案代碼    | 工作類別 | 工時 |
      | 需2025單001 | A07 其它 | 5.0  |
    Then 系統應顯示紅色警告
    And 警告訊息應為 "專案核定工時已用完，此記錄將超出預算"
    And 應該允許記錄但標示為超支
